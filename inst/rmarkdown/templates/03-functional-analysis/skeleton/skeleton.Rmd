---
## Alternatively, consider using the AcidGSEA package for fast preranked GSEA.
##
## - KEGG supported organisms:
##   http://www.genome.jp/kegg/catalog/org_list.html
## - OrgDb supported organisms:
##   http://bioconductor.org/packages/release/BiocViews.html#___OrgDb
##
## Refer to `rmarkdown::render()` for details on how to generate an HTML report
## from this template inside of an R script. In particular, the `params`
## argument is useful for passing in variables.
##
## Updated 2021-07-20.
params:
  title: "Functional analysis with clusterProfiler"

  ## DESeqAnalysis object file.
  ## Refer to DESeqAnalysis package for details.
  ## This is not the DESeqDataSet object.
  deseq_file: !r file.path("rds", "YYYY-MM-DD", "deseq.rds")

  ## Results (i.e. contrast) name or position.
  ## Refer to `resultsNames()` for details.
  results_name: "group_treatment_vs_control"

  ## Full Latin organism name (e.g. "Homo sapiens"). If left `NULL`, will
  ## attempt to detect from DESeqAnalysis object.
  organism: NULL

  ## Supported GO classes:
  ## - "BP": Biological Process
  ## - "MF": Molecular Function
  ## - "CC": Cellular Component
  go_class: "BP"

  ## Directory where R data files will be saved.
  data_dir: !r file.path("rds", Sys.Date())

  ## Directory where results, including CSV files, will be saved.
  results_dir: !r file.path("results", Sys.Date(), "functional-analysis")

  ## Pathview KEGG plots tend to be slow to render.
  pathview: FALSE

title: "`r params$title`"
author: "`r getOption('author')`"
date: "`r Sys.Date()`"

## This file is generated by the `prepareTemplate()` step in setup chunk.
bibliography: "bibliography.bib"
---

```{r setup, cache=FALSE, message=FALSE}
suppressPackageStartupMessages({
    library(goalie)
    library(stringr)
    library(bcbioRNASeq)
    library(DESeqAnalysis)
    library(AcidGSEA)
})
prepareTemplate()
source("_setup.R")
```

```{r dir-create}
kegg_plots_dir <- file.path(params$results_dir, "kegg-plots")
invisible(mapply(
    FUN = initDir,
    dir = c(params$data_dir, params$results_dir, kegg_plots_dir)
))
```

```{r header, child="_header.Rmd"}
```

# Prepare variables for enrichment analysis

First, we need to load the `DESeqAnalysis` object, which has been generated
from our `bcbioRNASeq` object during the differential expression step.

```{r load-deseqanalysis}
deseq <- import(params$deseq_file)
assert(
    is(deseq, "DESeqAnalysis"),
    validObject(deseq)
)
print(deseq)
```

We need to attach organism-specific packages from Bioconductor.

```{r bioc-packages, message=FALSE}
## Detect the organism from the DESeqDataSet object, if necessary.
organism <- params$organism
if (is.null(organism)) {
    organism <- organism(as(deseq, "DESeqDataSet"))
}

## Load Bioconductor packages. Only the current Bioconductor release for this
## template is supported, because it's too difficult to unit test and properly
## handle code changes.
assert(BiocManager::version() >= "3.12")
## Get OrgDb package from organism name (e.g. "org.Mm.eg.db").
match <- str_match(
    string = organism,
    pattern = "^([A-Z])[a-z]+\\s([a-z])[a-z]+$"
)
org_db <- paste(
    "org",
    paste(match[, 2L:3L], collapse = ""),
    "eg",
    "db",
    sep = "."
)
rm(match)
## Use `BiocManager::install()` to install missing packages, if necessary.
packages <- c(
    "clusterProfiler",
    "DOSE",
    "ggnewscale",  # For `cnetplot()` call below.
    "pathview",
    org_db
)
assert(allAreInstalled(packages))
invisible(lapply(
    X = basename(packages),
    FUN = function(package) {
        stopifnot(require(package, character.only = TRUE))
    }
))
## Avoid logical coercion error in DOSE.
## Report this issue to package author.
Sys.setenv(
    "_R_CHECK_LENGTH_1_CONDITION_" = "false",
    "_R_CHECK_LENGTH_1_LOGIC2_" = "false"
)
```

Match the KEGG organism code (e.g. "hsa" for Homo sapiens).

```{r check-db-codes}
kegg_code <-
    organism |>
    search_kegg_organism("scientific_name") |>
    getElement("kegg_code")
assert(
    hasLength(kegg_code, n = 1L),
    isMatchingRegex(pattern = "^[a-z]{3}$", x = kegg_code),
    isSubset(params$go_class, c("BP", "CC", "MF"))
)
```

We need to extract the corresponding `DESeqDataSet` and `DESeqResults` objects.

```{r get-deseqdataset}
dds <- as(deseq, "DESeqDataSet")
assert(
    is(dds, "DESeqDataSet"),
    validObject(dds)
)
print(dds)
```

```{r get-deseqresults}
## Refer to `resultsNames()` for available options.
res <- results(deseq, i = params$results_name)
assert(
    is(res, "DESeqResults"),
    validObject(res)
)
print(res)
```

Now we can prepare the gene list vectors required for enrichment analysis.

```{r results}
## Not allowing the user to apply post-hoc LFC filtering in params.
alpha_threshold <- alphaThreshold(res)
lfc_threshold <- lfcThreshold(res)
## Subset NA adjusted P values.
alert("Dropping genes without an adjusted P value.")
res <- res[!is.na(res$padj), , drop = FALSE]
res_df <- as.data.frame(res)
## Match the DESeqDataSet.
dds <- dds[rownames(res), , drop = FALSE]
## Use the all_genes vector for background (aka universe).
all_genes <- rownames(res)
## > help(topic = "deg", package = "DESeqAnalysis")
sig_genes <- deg(res)
sig_res_df <- res_df[sig_genes, , drop = FALSE]
sig_res_df <- sig_res_df[order(sig_res_df$padj), , drop = FALSE]
## LFC ranked list vector. 
lfc_vec <- sig_res_df$log2FoldChange
names(lfc_vec) <- rownames(sig_res_df)
lfc_vec <- sort(lfc_vec, decreasing = TRUE)
summary(lfc_vec)
```

# GO enrichment analysis

[Gene Ontology (GO)][GO] term enrichment is a technique for interpreting sets of genes making use of the [Gene Ontology][GO] system of classification, in which genes are assigned to a set of predefined bins depending on their functional characteristics.

```{r enrich-go}
enrich_go <- enrichGO(
    gene = sig_genes,
    OrgDb = org_db,
    keyType = "ENSEMBL",
    ont = params$go_class,
    universe = all_genes,
    qvalueCutoff = 0.05,
    readable = TRUE
)
print(enrich_go)
enrich_go_tbl <-
    enrich_go |>
    slot("result") |>
    as_tibble() |>
    camelCase()
saveData(
    enrich_go,
    enrich_go_tbl,
    dir = params$data_dir
)
export(
    object = enrich_go_tbl,
    file = file.path(
        params$results_dir,
        paste0(
            paste(
                "go",
                tolower(params$go_class),
                "clusterprofiler",
                "padj",
                alpha_threshold,
                "lfc",
                lfc_threshold,
                sep = "_"
            ),
            ".csv.gz"
        )
    )
)
print(enrich_go_tbl)
```

## Dot plot

```{r dotplot}
## Wrapping in `try()` call here so the R Markdown template doesn't fail due
## to unexpected clusterProfiler issues.
try({
    dotplot(enrich_go, showCategory = 25L)
})
```

## GO terms map

```{r emapplot}
## May encounter "Term similarity matrix not available" error here.
try({
    emapplot(enrich_go, showCategory = 25L)
})
```

## Gene map

In order to consider the potentially biological complexities in which a gene may belong to multiple annotation categories, and provide information of numeric changes if available.

Here we are plotting genes colored by LFC for top 5 most significant [GO][] terms.

```{r cnetplot}
try({
    ## May encounter warning from ggrepel package otherwise.
    options("ggrepel.max.overlaps" = Inf)
    cnetplot(enrich_go, foldChange = lfc_vec)
})
```

## GO GSEA analysis

A common approach in analyzing gene expression profiles was identifying differential expressed genes that are deemed interesting. The enrichment analysis we demonstrated previously were based on these differentially expressed genes. This approach will find genes where the difference is large, but it will not detect a situation where the difference is small, but evidenced in coordinated way in a set of related genes. [Gene Set Enrichment Analysis (GSEA)][GSEA] directly addresses this limitation. All genes can be used in [GSEA][]; [GSEA][] aggregates the per gene statistics across genes within a gene set, therefore making it possible to detect situations where all genes in a predefined set change in a small but coordinated way. Since it is likely that many relevant phenotypic differences are manifested by small but consistent changes in a set of genes.

```{r ranked-list}
ranked_list_ensembl <- RankedList(
    object = deseq,
    value = "stat",
    keyType = "geneId"
)
ranked_list_ensembl <- ranked_list_ensembl[[params$results_name]]
assert(
    is.numeric(ranked_list_ensembl),
    hasNames(ranked_list_ensembl)
)
## Entrez identifiers must be defined in the "entrezId" column of DESeqDataSet
## rowData, otherwise this step will fail.
ranked_list_entrez <-
    tryCatch(
        expr = {
            ## FIXME This is currently erroring on our F1000 example.
            ## Need to rework approach in AcidGSEA?
            x <- RankedList(
                object = deseq,
                value = "stat",
                keyType = "entrezId"
            )
            x <- x[[params$results_name]]
            x
        },
        error = function(e) NULL
    )
eval_entrez <- is.numeric(ranked_list_entrez)
```

```{r gse-go}
## Now we're ready to run GSEA.
## > help("gseGO", "clusterProfiler")
## Consider: minGSSize = 100
gsea_go <- gseGO(
    geneList = ranked_list_ensembl,
    ont = params$go_class,
    OrgDb = get(org_db),
    keyType = "ENSEMBL",
    pvalueCutoff = 0.05
)
print(gsea_go)
## FIXME Does the base R pipe work here?
gsea_go_tbl <-
    gsea_go |>
    slot("result") |>
    as_tibble() |>
    camelCase()
saveData(gsea_go, gsea_go_tbl, dir = params$data_dir)
export(
    object = gsea_go_tbl,
    file = file.path(
        params$results_dir,
        paste0(
            paste(
                "gsea",
                "clusterprofiler",
                "padj",
                alpha_threshold,
                "lfc",
                lfc_threshold,
                sep = "_"
            ),
            ".csv.gz"
        )
    )
)
print(gsea_go_tbl)
```

# KEGG enrichment analysis

[Entrez][] identifiers are required for [Kyoto Encyclopedia of Genes and Genomes (KEGG)][KEGG] analysis. Here we are defining 1:1 mappings of the [Ensembl][] gene identifiers to [Entrez][] identifiers. For genes that map to multiple [Entrez][] identifiers, we are using the oldest identifier to define the 1:1 mapping.

Now let's get the background of unique Entrez IDs.

```{r all-entrez, eval=eval_entrez}
## Unique Entrez IDs to use for background.
all_entrez <-
    gene2entrez %>%
    unique() %>%
    as.integer() %>%
    sort() %>%
    as.character()
str(all_entrez)
```

Now we need to map the DESeqResults values to our Entrez IDs. Let's obtain a vector of significant genes that map to Entrez.

```{r sig-gene2entrez, eval=eval_entrez}
## Significant genes that map to Entrez ID.
sig_gene2entrez <- gene2entrez[intersect(sig_genes, names(gene2entrez))]
## Note that these can be duplicated.
if (any(duplicated(sig_gene2entrez))) {
    alertWarning("Duplicate Entrez IDs detected.")
}
str(sig_gene2entrez)
```

Note that this vector can contain duplicate Entrez IDs, which we will resolve by significance (adjusted P value).

```{r entrez-res, eval=eval_entrez}
## FIXME REWORK THIS USING ACIDGSEA APPROACH...
stopifnot(all(names(sig_gene2entrez) %in% rownames(res_df)))
## Filter to contain only significant genes that map to Entrez.
sig_entrez_res_df <-
    res_df %>%
    .[names(sig_gene2entrez), , drop = FALSE] %>%
    rownames_to_column("geneID") %>%
    as_tibble() %>%
    mutate(entrezID = sig_gene2entrez) %>%
    group_by(entrezID) %>%
    ## Get the most significant result, per Entrez ID.
    top_n(n = 1, wt = padj) %>%
    as.data.frame() %>%
    set_rownames(.$entrezID)
saveData(sig_entrez_res_df, dir = params$data_dir)
sig_entrez <- pull(sig_entrez_res_df, entrezID)
## Extract the fold changes.
entrez_lfc_vec <- sig_entrez_res_df$log2FoldChange
names(entrez_lfc_vec) <- sig_entrez_res_df$entrezID
## Sort from upregulated to downregulated.
entrez_lfc_vec <- sort(entrez_lfc_vec, decreasing = TRUE)
str(entrez_lfc_vec)
```

```{r enrich-kegg}
kegg <- enrichKEGG(
    gene = as.character(sig_entrez),
    organism = kegg_code,
    keyType = "ncbi-geneid",
    universe = as.character(all_entrez),
    qvalueCutoff = 0.05
)
print(kegg)
kegg_tbl <-
    kegg %>%
    slot("result") %>%
    as_tibble() %>%
    camelCase()
saveData(kegg, kegg_tbl, dir = params$data_dir)
export(
    object = kegg_tbl,
    file = file.path(
        params$results_dir,
        paste0(
            paste(
                "kegg",
                "clusterprofiler",
                "padj",
                alpha_threshold,
                "lfc",
                lfc_threshold,
                sep = "_"
            ),
            ".csv.gz"
        )
    )
)
print(kegg_tbl)
```

## KEGG GSEA analysis

[GSEA][] analysis is performed with the [clusterProfiler][] tool using KEGG gene sets and using the log2 fold changes as input. By using the log2 fold changes as the input, we are identifying pathways with genes that exhibit coordinated fold changes that are larger than might be expected by chance. The significant pathways can be visualized using the log2 fold changes with the Pathview tool.

Gene set enrichment analysis tools use ranked lists of genes (here ranked by log2FC) without using a threshold. This allows the tools to use more information to identify enriched biological processes. The [introduction to gene set enrichment analysis](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC1239896) goes into more detail about some of the advantages of this approach. By using the log2 fold changes as the input, we are identifying pathways with genes that exhibit coordinated fold changes that are larger than might be expected by chance. The significant pathways can be visualized using the log2 fold changes with the [pathview][] tool.

The significantly dysregulated pathways (q-value (FDR) < 0.05) are displayed below in the pathway images, which show the degree of dysregulation of the genes (the minus direction (green) is down-regulated, while the positive direction (red) is up-regulated).

When performing [GSEA][] analysis it may be useful to adjust the minGSSize and/or maxGSSize parameter based on the pathways you would like to search for significance. If you are interested in smaller pathways, such as phototransduction, which has a gene set size of 24 genes, then you would want to adjust the minGSSize to less than 24. If you are only interested in larger pathways, then you would want to adjust the GSSize to a larger number. The fewer pathways tested, the less we need to correct for multiple test correction, so by adjusting the minGSSize and maxGSSize parameters you can test fewer pathways and limit testing to the pathways of interest.

```{r kegg-gsea}
gsea_kegg <- gseKEGG(
    geneList = entrez_lfc_vec,
    organism = kegg_code,
    keyType = "ncbi-geneid"
)
print(gsea_kegg)
gsea_kegg_tbl <-
    gsea_kegg %>%
    slot("result") %>%
    as_tibble() %>%
    camelCase()
saveData(gsea_kegg, dir = params$data_dir)
export(
    object = gsea_kegg_tbl,
    file = file.path(
        params$results_dir, 
        paste0(
            paste(
                "gsea",
                "kegg",
                "clusterprofiler",
                "padj",
                alpha_threshold,
                "lfc",
                lfc_threshold,
                sep = "_"
            ),
            ".csv.gz"
        )
    )
)
print(gsea_kegg_tbl)
```

```{r pathview-kegg-plots, message=FALSE, results="asis", eval=params$pathview}
## > help("pathview", "pathview")
##
## There is currently no way to set the output path of the pathview PNG files, so
## we're changing the working directory. Generally this is not recommended!
##
## Also, We're using `tryCatch()` here to return to the user any pathways that
## didn't output graphics correctly.
pathways <- gsea_kegg_tbl$id
if (length(pathways) > 0L) {
    ## dplyr may need to be unloaded for pathview to work.
    ## > suppressWarnings(detach("package:dplyr", unload = TRUE, force = TRUE))
    wd <- getwd()
    setwd(kegg_plots_dir)
    invisible(lapply(pathways, function(pathway) {
        ## `gene.data` vector should be numeric with Entrez IDs as names.
        tryCatch(
            pathview(
                gene.data = entrez_lfc_vec,
                pathway.id = pathway,
                species = kegg_code, 
                limit = list(gene = 2, cpd = 1)
            ),
            error = function(e) {
                ## Return a warning instead of an error.
                warning(paste(pathway, "failed to plot."), call. = FALSE)
            }
        )
    }))
    setwd(wd)
    figures <- list.files(
        path = kegg_plots_dir,
        pattern = "pathview",
        full.names = TRUE
    )
    invisible(lapply(figures, function(figure) {
        cat(paste0("<img src=\"", figure, "\">\n"))
    }))
}
```

```{r footer, child="_footer.Rmd"}
```

```{r links, child="_links.Rmd"}
```
